#!/usr/bin/env sh

echo "游 Rodando migrations do RBAC..."
php tests/codeception/bin/yii migrate --migrationPath=@yii/rbac/migrations/ --interactive=0 > /dev/null 2>&1 || echo "游뛂 Ocorreu um erro ao rodar as migrations. Rode manualmente para ver o problema."

echo "游 Preparando Codeception..."
./vendor/bin/codecept build --config=tests/codeception.yml > /dev/null 2>&1 || "游뛂 N칚o foi poss칤vel fazer o build do Codeception."

if [ $# -ge 1 ]
then
  echo "游 Rodando migrations..."
  php tests/codeception/bin/yii migrate --interactive=0 > /dev/null 2>&1 || echo "游뛂 Ocorreu um erro ao rodar as migrations. Rode manualmente para ver o problema."

  echo "游 Rodando teste..."
  # Remove o come칞o do diret칩rios ("tests/") para que funcione o comando:
  ./vendor/bin/codecept run --config=tests/codeception.yml $(echo $1 | sed 's/tests\///g')
  #Para debugar testes unit치rios, descomentar a linha abaixo
  #./vendor/bin/codecept run --debug --config=tests/codeception.yml $(echo $1 | sed 's/tests\///g')
  EXIT_CODE=$?

else
  echo "游 Rodando su칤te de testes..."
  ./vendor/bin/codecept run --config=tests/codeception.yml --coverage --coverage-html
  EXIT_CODE=$?

  echo "游 Analisando qualidade de c칩digo..."
  ./vendor/bin/php-hound --ignore=config,runtime,tests,vendor,views,web,requirements.php .

  echo "游 Abrindo relat칩rio de cobertura de c칩digo..."
  open tests/codeception/_output/coverage/index.html
fi

echo "游 Feito!"
exit $EXIT_CODE
